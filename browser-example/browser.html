<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="text/javascript" src="../dist/sdk-browser.js"></script>
    <script type="text/javascript">


      // Fill them as should
      let fixedUsername = '...@cozify.fi'
      let fixedPassword = 'xxx'
      let fixedHubId = 'xxxx-xxxx'
      let fixedDeviceId = 'abcd-efgh'
      let fixedDeviceName = 'Windpow'


      let LANGUAGES = CozifySDK.LANGUAGES;
      let USER_STATES = CozifySDK.USER_STATES;

      CozifySDK.watchChanges('user.state', (newState, oldState) => {
        console.log('user.state changed from %s to %s', oldState, newState);
      });

      /** Listener for specific changes */
      CozifySDK.watchChanges('connections.cloudState', (newState, oldState) => {
        console.log('connections.cloudState changed from %s to %s', oldState, newState);
      });

      console.info(`Initial user state ${CozifySDK.getUserState()}`);
      console.info(`--1--`);

      CozifySDK.changeLanguage(LANGUAGES.FI_FI);
      console.info(`--2--`);


      CozifySDK.setAuthenticated( cozifyCloudToken )


      /*
      CozifySDK.doPwLogin( fixedUsername, fixedPassword )
        .then((response) => {
          CozifySDK.acceptEula();
          console.info(`--3--`);

          //CozifySDK.doLogout();
          //console.info(`--4--`);

        })
        .catch(function (error) {
          console.info(`Pw failure when user state ${CozifySDK.getCloudConnectionState()}`, error);
        })
      */

      CozifySDK.startDiscoveringHubs(fixedHubId);

      CozifySDK.watchChanges('hubs', (newHubsState, oldHubsState) => {
        if (newHubsState[fixedHubId] && !newHubsState[fixedHubId].selected) {
          CozifySDK.selectHubById(fixedHubId, true);
          CozifySDK.stopDiscoveringHubs(fixedHubId);
          setTimeout(function() {
            CozifySDK.stopPolling(fixedHubId);
          }, 20000);
        };
        if (newHubsState[fixedHubId].connectionState == CozifySDK.HUB_CONNECTION_STATES.LOCAL){
          CozifySDK.startPairing(fixedHubId, true)
          setTimeout(function() {
                      CozifySDK.stopPairing(fixedHubId);
                      console.error('Pairing stopped')
                    }, 30000);

        }
        if (newHubsState[fixedHubId] && oldHubsState[fixedHubId]){
          if (newHubsState[fixedHubId].connectionState !== oldHubsState[fixedHubId].connectionState) {
            console.log('Hub connectionState changed from %s to %s', oldHubsState[fixedHubId].connectionState, newHubsState[fixedHubId].connectionState);
          }
        }

      });

      let devicePaired = false;
      CozifySDK.watchChanges('pairings', (newPairingsState, oldPairingsState) => {
         if ( newPairingsState[fixedHubId]) {
            Object.values(newPairingsState[fixedHubId]).forEach((pairing)=> {
              const device = pairing.status
              if (device && device.name === fixedDeviceName && !devicePaired ) {
                if (pairing.pairingStatus === "CONNECTED") {
                  {
                    devicePaired = true;

                    if (pairing.actionRequired){
                      alert(device.actionRequired)
                    } else {
                      let state = device.state;
                      state.isOn = !state.isOn;

                      // CozifySDK.sendDeviceStateCmd(fixedHubId, device.id, state, ['isOn', 'type']);
                      CozifySDK.identifyDevice(fixedHubId, device.id)
                      CozifySDK.ignorePairing(fixedHubId, device.id, false)
                      CozifySDK.setDeviceMeta(fixedHubId, device.id, fixedDeviceName, ["652ec684-c02f-4490-9f9a-b6b29f81a92d"])
                      /*
                      setTimeout(function() {
                        console.error('Device will be paired', device.id)

                      }, 5000)
                      */
                    }

                  }
                }
                /*
                setTimeout(function() { CozifySDK.identifyDevice(fixedHubId, device.id) }, 5000)
                setTimeout(function() { CozifySDK.setDeviceMeta(fixedHubId, device.id, fixedDeviceName) }, 6000)
                setTimeout(function() { CozifySDK.ignorePairing(fixedHubId, device.id, false) }, 7000)
                */



              }
            })
         }

      });

      let deviceStateChanged = false;
      CozifySDK.watchChanges('devices', (newDevicesState, oldDevicesState) => {
        if ( newDevicesState[fixedHubId]) {
          Object.values(newDevicesState[fixedHubId]).forEach((device)=> {
            if (device.name === fixedDeviceName && device.state && !deviceStateChanged ) {
              let state = device.state;
              state.isOn = !state.isOn;
              /*
              CozifySDK.sendDeviceStateCmd(fixedHubId, device.id, state, ['isOn', 'type']);
              */
              deviceStateChanged = true;
              /*
              setTimeout(function() {
                CozifySDK.unpairDevice(fixedHubId, device.id, true)
                console.error('Device will be ignored', device.id)
              }, 2000);
              */
            }
          })
        }
      });


      /** Listener for store changes like React will internally do */
      CozifySDK.store.subscribe(() => {
        const storeNow = CozifySDK.store.getState()
        //console.info("Hub connection:", CozifySDK.getHubConnectionState(fixedHubId));
        console.info("Hubs", storeNow.hubs)
        console.info("Devices:", CozifySDK.getDevices()[fixedHubId])
        console.info("Pairings:", CozifySDK.getPairingDevices()[fixedHubId])
      })

    </script>
    <title>cozify-sdk</title>
  </head>

  <body>
    <p>
      Testing Cozify SDK in browser
    </p>
    <noscript>
      You need to enable JavaScript to run this app.
    </noscript>

  </body>
</html>

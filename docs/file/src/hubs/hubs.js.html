<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/hubs/hubs.js | Cozify SDK</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Cozify UI SDK for REST aPI"><meta property="og:type" content="website"><meta property="og:url" content="http://my-library.org"><meta property="og:site_name" content="Cozify SDK"><meta property="og:title" content="Cozify SDK"><meta property="og:image" content="http://my-library.org/logo.png"><meta property="og:description" content="Cozify UI SDK for REST aPI"><meta property="og:author" content="https://twitter.com/foo"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Cozify SDK"><meta property="twitter:description" content="Cozify UI SDK for REST aPI"><meta property="twitter:image" content="http://my-library.org/logo.png"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/foo/bar"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-watchChanges">watchChanges</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-urlBase64Decode">urlBase64Decode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-store">store</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isNode">isNode</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#connection">connection</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resetRetry">resetRetry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-retryCondition">retryCondition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cloudErrorState">cloudErrorState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAPIversion">getAPIversion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hubErrorState">hubErrorState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-testSSLCertificate">testSSLCertificate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-send">send</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendAll">sendAll</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCloudConnectionState">getCloudConnectionState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getHubConnectionState">getHubConnectionState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setCloudConnectionState">setCloudConnectionState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setHubConnectionState">setHubConnectionState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CLOUD_API_VERSION">CLOUD_API_VERSION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CLOUD_FINGERPRINTS_SHA1">CLOUD_FINGERPRINTS_SHA1</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CLOUD_HOST">CLOUD_HOST</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CLOUD_URL">CLOUD_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-MAX_API_VERSION">MAX_API_VERSION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-CLOUD_CONNECTION_STATE_TYPE">CLOUD_CONNECTION_STATE_TYPE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-COMMANDS_TYPE">COMMANDS_TYPE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-COMMANDS_TYPE">COMMANDS_TYPE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-HUB_CONNECTION_STATE_TYPE">HUB_CONNECTION_STATE_TYPE</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#devices">devices</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-identifyDevice">identifyDevice</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendDeviceCmd">sendDeviceCmd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendDeviceStateCmd">sendDeviceStateCmd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setDeviceMeta">setDeviceMeta</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-unpairDevice">unpairDevice</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-devicesDeltaHandler">devicesDeltaHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getDevices">getDevices</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getHubDevices">getHubDevices</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getHubPairingDevices">getHubPairingDevices</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getPairingDevices">getPairingDevices</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pairingDevicesDeltaHandler">pairingDevicesDeltaHandler</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#hubs">hubs</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-connectHubByTokens">connectHubByTokens</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-doPoll">doPoll</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getHubs">getHubs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ignorePairingByIds">ignorePairingByIds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-selectHubById">selectHubById</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-startDiscoveringHubs">startDiscoveringHubs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-startPairingById">startPairingById</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-startPollingById">startPollingById</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stopDiscoveringHubs">stopDiscoveringHubs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stopPairingById">stopPairingById</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stopPairings">stopPairings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stopPollingById">stopPollingById</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-unSelectHubById">unSelectHubById</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-unSelectHubs">unSelectHubs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DISCOVERY_INTERVAL_MS">DISCOVERY_INTERVAL_MS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-HUB_PORT">HUB_PORT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-HUB_PROTOCOL">HUB_PROTOCOL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-HUB_STATES">HUB_STATES</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PAIRING_POLL_INTERVAL_MS">PAIRING_POLL_INTERVAL_MS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-POLL_INTERVAL_MS">POLL_INTERVAL_MS</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#reducers">reducers</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-connectionsState">connectionsState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-setCloudConnectionState">setCloudConnectionState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-devicesState">devicesState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-setDevices">setDevices</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-hubsState">hubsState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateHubs">updateHubs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-rootReducer">rootReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-pairingsState">pairingsState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-setPairingDevices">setPairingDevices</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-roomsState">roomsState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-setRooms">setRooms</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-changeState">changeState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-userState">userState</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#rooms">rooms</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addRoom">addRoom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-editRoom">editRoom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getHubRooms">getHubRooms</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getRooms">getRooms</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-removeRoom">removeRoom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-roomsDeltaHandler">roomsDeltaHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendRoomCmd">sendRoomCmd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ROOMS_EN">ROOMS_EN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ROOMS_FI">ROOMS_FI</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#user">user</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-acceptEula">acceptEula</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-changeLanguage">changeLanguage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-doPwLogin">doPwLogin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUserState">getUserState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setAuthenticated">setAuthenticated</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LANGUAGES">LANGUAGES</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ROLES">ROLES</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-USER_STATES">USER_STATES</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/hubs/hubs.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// 
import isEmpty from &apos;lodash/isEmpty&apos;;
import {
  DISCOVERY_INTERVAL_MS, POLL_INTERVAL_MS, PAIRING_POLL_INTERVAL_MS, HUB_PROTOCOL, HUB_PORT,
} from &apos;./constants&apos;;
import { USER_STATES, ROLES } from &apos;../user/constants&apos;;
import { HUB_CONNECTION_STATES } from &apos;../connection/constants&apos;;
import { COMMANDS, send, sendAll } from &apos;../connection/send&apos;;

import { devicesDeltaHandler, pairingDevicesDeltaHandler } from &apos;../devices/devices&apos;;
import { roomsDeltaHandler } from &apos;../rooms/rooms&apos;;
import { urlBase64Decode } from &apos;../utils&apos;;
import { store, watchChanges } from &apos;../store&apos;;
import { hubsState } from &apos;../reducers/hubs&apos;;
import { userState } from &apos;../reducers/user&apos;;



let hubsMap = {};


/*
 * Helper method to extract hub info from JWT based hub keys
 */
function extractHubInfo(HUBKeys) {
  const hubs = {};
  if (HUBKeys) {
    Object.keys(HUBKeys).forEach((hubKey) =&gt; {
      const coded = HUBKeys[hubKey].split(&apos;.&apos;)[1];
      const decoded = urlBase64Decode(coded);
      const payload = JSON.parse(decoded);
      const info = {};
      info.id = payload.hubId || payload.hub_id;
      info.name = payload.hubName || payload.hub_name;
      info.hubKey = HUBKeys[hubKey];
      info.connectionState = HUB_CONNECTION_STATES.UNCONNECTED;
      if (payload.role) {
        info.role = payload.role;
        info.roleString = &apos;&apos;;
        Object.keys(ROLES).forEach((roleKey) =&gt; {
          if (ROLES[roleKey] === info.role) info.roleString = roleKey;
        });
      }
      hubs[info.id] = info;
    });
  }
  return hubs;
}


/*
 * Hub metadata is received and will be stored
 */
function updateFoundHub(hubURL, hub) {
  const foundHub = hub;
  // Hub keys returns ids, idQuerys return hubId
  if (foundHub.hubId) {
    foundHub.id = foundHub.hubId;
    delete foundHub.hubId;
  }
  if (!foundHub.id) {
    return;
  }

  if (!hubsMap[foundHub.id]) {
    hubsMap[foundHub.id] = {
      id: foundHub.id,
      name: foundHub.name || &apos;&apos;,
    };
  }
  hubsMap[foundHub.id].connected = foundHub.connected;
  hubsMap[foundHub.id].features = foundHub.features;
  hubsMap[foundHub.id].state = foundHub.state;
  hubsMap[foundHub.id].version = foundHub.version;
  hubsMap[foundHub.id].connectionState = foundHub.connected ? HUB_CONNECTION_STATES.REMOTE : HUB_CONNECTION_STATES.UNCONNECTED;
  if (hubURL) {
    hubsMap[foundHub.id].connectionState = HUB_CONNECTION_STATES.LOCAL;
    hubsMap[foundHub.id].url = hubURL;
  } else {
    hubsMap[foundHub.id].url = undefined;
  }
}

/*
 * Remote hub metamata request for version etc information
 */
function doRemoteIdQuery(hubId, authKey, hubKey) {
  return new Promise((resolve, reject) =&gt; {
    send({
      command: COMMANDS.CLOUD_META, authKey, hubKey, hubId,
    })
      .then((hubData) =&gt; {
        updateFoundHub(undefined, hubData);
        resolve(hubId);
      })
      .catch((error) =&gt; {
        console.log(`doRemoteIdQuery ${hubId} error `, error.message);
        reject(hubId);
      });
  });
}

/*
 * Local hub metadata request for version etc information
 */
function doLocalIdQuery(ip) {
  return new Promise((resolve) =&gt; {
    if (ip) {
      const hubURL = `${HUB_PROTOCOL + ip}:${HUB_PORT}`;
      const url = `${hubURL}/hub`;
      send({ url, timeout: 500 })
        .then((hubData) =&gt; {
          updateFoundHub(hubURL, hubData);
          resolve(ip);
        })
        .catch((error) =&gt; {
          console.log(`doLocalIdQuery ${ip} error `, error.message);
          resolve(ip);
        });
    } else {
      resolve();
    }
  });
}

/**
 * Helper to get current hubs from state
 * @return {HUBS_MAP_TYPE} - hubs
 */
export function getHubs() {
  return hubsState.selectors.getHubs(store.getState());
}

/*
 * Check hubs that are currently selected and mark them selected also in map of given hubs
 */
function setSelectedHubs(newHubs) {
  const hubs = getHubs();
  (Object.values(hubs)).forEach((hub) =&gt; {
    if (hub.selected) {
      const selectedNewHub = newHubs[hub.id];
      if (selectedNewHub) {
        selectedNewHub.selected = true;
      }
    }
  });
}

/*
 * Fetch HUB IP addresses and metadata of those in the same network
 */
function doCloudDiscovery() {
  return new Promise((resolve) =&gt; {
    send({ command: COMMANDS.CLOUD_IP })
      .then((ips) =&gt; {
        const queries = [];
        if (ips &amp;&amp; !isEmpty(ips)) {
          ips.forEach((ip) =&gt; {
            queries.push(doLocalIdQuery(ip));
          });
        }
        sendAll(queries)
          .finally(() =&gt; {
            // mark selected hubs to be selected after
            setSelectedHubs(hubsMap);
            store.dispatch(hubsState.actions.updateHubs(hubsMap));
            resolve(&apos;ok&apos;);
          });
      })
      .catch((error) =&gt; {
        console.error(&apos;doCloudDiscovery error: &apos;, error.message);
        store.dispatch(hubsState.actions.updateHubs(hubsMap));
        resolve(&apos;error&apos;);
      });
  });
}

/*
 * Fetch hub metadatas from Cloud
 */
function fetchCloudMetaData(hubs, authKey) {
  return new Promise((resolve) =&gt; {
    const queries = [];
    (Object.values(hubs)).forEach((hub) =&gt; {
      if (hub.hubKey) {
        queries.push(doRemoteIdQuery(hub.id, authKey, hub.hubKey));
      }
    });
    sendAll(queries)
      .then((values) =&gt; {
        console.debug(&apos;fetchCloudMetaData values&apos;, values);
      })
      .catch((error) =&gt; {
        console.error(&apos;fetchCloudMetaData error&apos;, error);
      })
      .finally(() =&gt; {
        resolve();
      });
  });
}


/**
 * Helper to get current user from state
 */
function storedUser() {
  return userState.selectors.getUser(store.getState());
}

/*
 * Make hubsMap by fetching hub meta data from cloud and local
 */
function makeHubsMap(tokens, sync = false) {
  const { authKey } = storedUser();
  return new Promise((resolve) =&gt; {
    hubsMap = extractHubInfo(tokens);
    store.dispatch(hubsState.actions.updateHubs(hubsMap));
    fetchCloudMetaData(hubsMap, authKey)
      .finally(() =&gt; {
        if (sync) {
          doCloudDiscovery().then(() =&gt; resolve(getHubs())).catch(() =&gt; resolve(getHubs()));
        } else {
          doCloudDiscovery();
          resolve(getHubs());
        }
      });
  });
}

/*
 * Fetch Hub keys by user authKey and start fetching hub meta datas
 */
function fetchHubs() {
  const { authKey } = storedUser();
  return new Promise((resolve, reject) =&gt; {
    if (!authKey) {
      reject(new Error(&apos;No userKey!&apos;));
      return;
    }
    send({ command: COMMANDS.HUB_KEYS, authKey })
      .then((tokens) =&gt; {
        if (tokens) {
          makeHubsMap(tokens).then((hubs) =&gt; resolve(hubs));
          /*
          hubsMap = extractHubInfo(tokens);
          store.dispatch(hubsState.actions.updateHubs(hubsMap));
          fetchCloudMetaData(hubsMap, authKey)
            .finally(() =&gt; {
              doCloudDiscovery();
              resolve(getHubs());
            });
          */
        } else {
          resolve(getHubs());
        }
      })
      .catch((error) =&gt; {
        console.error(&apos;fetchHubTokens error: &apos;, error.message);
        reject(error);
      });
  });
}


let discoveryInterval;

/**
 * Start discovering hubs every DISCOVERY_INTERVAL_MS
 * Sequence includes requests of hub-keys, remote meta-infos, lan-ips and local meta-infos
 */
export function startDiscoveringHubs() {
  if (!discoveryInterval) {
    // call immediately...
    fetchHubs();
    // and then every DISCOVERY_INTERVAL_MS (30s?)
    discoveryInterval = setInterval(fetchHubs, DISCOVERY_INTERVAL_MS);
  }
}

/**
 * Stop discovering hubs
 */
export function stopDiscoveringHubs() {
  clearInterval(discoveryInterval);
}

/*
** Pairing
 */

const pairingIntervals = {};
const pairingStopped = {};
const pairingTimeStamp = {};
const pairingInAction = {};


/*
 * Do pairing of given hub if hub connection is ok
 * Remote pairing is executed only every second call
 * @param {string} hubId
 * @param {booleam} reset - set true for full scan, false if delta only
 * @return none
 */
function doPairingById(hubId, reset = false) {
  let doRest = reset;
  if (pairingStopped[hubId]) {
    console.debug(&apos;doPairing: pairing stopped&apos;);
    return;
  }
  if (!pairingTimeStamp[hubId]) {
    pairingTimeStamp[hubId] = 0;
  }

  const hub = getHubs()[hubId];
  const { authKey } = storedUser();
  const { hubKey } = hub;

  console.debug(&apos;doPairing connection state: &apos;, hub.connectionState);
  if (hub.connectionState !== HUB_CONNECTION_STATES.LOCAL &amp;&amp; hub.connectionState !== HUB_CONNECTION_STATES.REMOTE) {
    console.error(&apos;SDK doPairing error: no Hub connection&apos;);
    return;
  }

  if (pairingInAction[hubId]) {
    return;
  }
  pairingInAction[hubId] = true;

  if (doRest) pairingTimeStamp[hubId] = 0;
  doRest = pairingTimeStamp[hubId] === 0;

  send({
    command: COMMANDS.PAIR_START, hubId, authKey, hubKey, localUrl: hub.url, data: { ts: pairingTimeStamp[hubId] },
  })
    .then((delta) =&gt; {
      if (delta) {
        pairingTimeStamp[hubId] = delta.timestamp;
        switch (delta.type) {
          case &apos;SCAN_DELTA&apos;: {
            pairingDevicesDeltaHandler(hubId, doRest, delta.devices);
            break;
          }
          default: {
            break;
          }
        }
      }
      pairingInAction[hubId] = false;
    })
    .catch((error) =&gt; {
    // store.dispatch(hubsState.actions.hubPollFailed())
      console.error(&apos;SDK: doPairing error: &apos;, error.message);
      pairingInAction[hubId] = false;
    });
}

/**
 * Set pairing ignore flag of given device in given hub
 * @param {string} hubId
 * @param {string} deviceId
 * @param {boolean} ignore
 * @return none
 */
export function ignorePairingByIds(hubId, deviceId, ignore) {
  const { authKey } = storedUser();
  const hub = getHubs()[hubId];
  const { hubKey } = hub;
  send({
    command: COMMANDS.PAIR_IGNORE, hubId, authKey, hubKey, localUrl: hub.url, data: { id: deviceId, ignored: ignore },
  })
    .then((data) =&gt; {
      console.debug(&apos;SDK: scanIgnore: Ok , data: &apos;, data);
    })
    .catch((error) =&gt; {
    // store.dispatch(hubsState.actions.hubPollFailed())
      console.error(&apos;SDK: scanIgnore error: &apos;, error.message);
    });
}


/**
 * Start pairing on given hub
 * @param {string} hubId
 * @param {booleam} reset - set true for full scan, false if delta only
 * @return none
 */
export function startPairingById(hubId, reset) {
  const intervalTime = PAIRING_POLL_INTERVAL_MS;
  pairingStopped[hubId] = false;
  doPairingById(hubId, reset);
  pairingIntervals[hubId] = setInterval(doPairingById, intervalTime, hubId, reset);
}

const stopPairingInAction = {};
/**
 * Stop pairing on given hub
 * @param {string} hubId
 * @return none
 */
export function stopPairingById(hubId) {
  if (stopPairingInAction[hubId]) {
    return;
  }
  stopPairingInAction[hubId] = true;

  const { authKey } = storedUser();
  const hub = getHubs()[hubId];
  const { hubKey } = hub;


  clearInterval(pairingIntervals[hubId]);
  send({
    command: COMMANDS.PAIR_STOP, hubId, authKey, hubKey, localUrl: hub.url,
  })
    .then((data) =&gt; {
      console.debug(&apos;SDK: pairingStopped: Ok , data: &apos;, data);
      pairingStopped[hubId] = true;
      stopPairingInAction[hubId] = false;
    })
    .catch((error) =&gt; {
    // store.dispatch(hubsState.actions.hubPollFailed())
      console.error(&apos;SDK: pairingStopped error: &apos;, error.message);
      stopPairingInAction[hubId] = false;
    });
}

/**
 * Stop pairing on all hubs
 * @return none
 */
export function stopPairings() {
  const hubs = getHubs();
  (Object.values(hubs)).forEach((hub) =&gt; {
    stopPairingById(hub.id);
  });
}

/*
** Polling
*/
const pollIntervals = {};
const pollingStopped = {};
const pollTimeStamp = {};
const pollInAction = {};
const secondPoll = {};


/**
 * Do poll on given hub if hub connection is ok.
 * Remote polls are executed only every second call.
 * @param {string} hubId
 * @param {booleam} reset - set true for full scan, false if delta only
 * @return {Promise} status or error
 */
export function doPoll(hubId, reset = false) {
  return new Promise((resolve, reject) =&gt; {
    let doReset = reset;
    if (doReset) pollTimeStamp[hubId] = 0;
    doReset = pollTimeStamp[hubId] === 0;

    if (pollingStopped[hubId]) {
      console.debug(&apos;doPolling: polling stopped&apos;);
      resolve(&apos;stopped&apos;);
      return;
    }
    if (!pollTimeStamp[hubId]) {
      pollTimeStamp[hubId] = 0;
    }
    const hub = getHubs()[hubId];
    console.debug(&apos;doPoll connection state: &apos;, hub.connectionState);
    if (hub.connectionState !== HUB_CONNECTION_STATES.LOCAL &amp;&amp; hub.connectionState !== HUB_CONNECTION_STATES.REMOTE) {
      console.error(&apos;SDK doPoll error: No Hub connection&apos;);
      reject(new Error(&apos;doPoll error: No Hub connection&apos;));
      return;
    }

    // just return every second -&gt; not doing so often as in local connection
    if (hub.connectionState === HUB_CONNECTION_STATES.REMOTE &amp;&amp; !doReset) {
      if (secondPoll[hubId]) {
        secondPoll[hubId] = false;
        resolve(&apos;skipped&apos;);
        return;
      }
      secondPoll[hubId] = true;
    }

    const { authKey } = storedUser();
    const { hubKey } = hub;

    if (pollInAction[hubId]) {
      reject(new Error(&apos;doPoll error: Already polling&apos;));
      return;
    }
    pollInAction[hubId] = true;

    send({
      command: COMMANDS.POLL, hubId, authKey, hubKey, localUrl: hub.url, data: { ts: pollTimeStamp[hubId] },
    })
      .then((deltas) =&gt; {
        if (deltas) {
        // console.log(JSON.stringify(deltas));
        // Return can be null poll, even if not asked that
          if (pollTimeStamp[hubId] === 0 || deltas.full) {
            doReset = true;
          }

          pollTimeStamp[hubId] = deltas.timestamp;

          deltas.polls.forEach((delta) =&gt; {
            switch (delta.type) {
              case &apos;DEVICE_DELTA&apos;: {
                devicesDeltaHandler(hubId, doReset, delta.devices);
                break;
              }
              case &apos;GROUP_DELTA&apos;: {
                break;
              }
              case &apos;SCENE_DELTA&apos;: {
                break;
              }
              case &apos;RULE_DELTA&apos;: {
                break;
              }
              case &apos;USERS_DELTA&apos;: {
                break;
              }
              case &apos;ROOM_DELTA&apos;: {
                roomsDeltaHandler(hubId, doReset, delta.rooms);
                break;
              }
              case &apos;ZONE_DELTA&apos;: {
                break;
              }
              case &apos;ALARM_DELTA&apos;: {
                break;
              }
              default: {
                break;
              }
            }
          });
        }
        pollInAction[hubId] = false;
        resolve(&apos;done&apos;);
      })
      .catch((error) =&gt; {
      // store.dispatch(hubsState.actions.hubPollFailed())
        console.error(&apos;SDK doPoll error: &apos;, error.message);
        pollInAction[hubId] = false;
        reject(error);
      });
  });
}


/**
 * Start polling on given hub
 * @param {string} hubId
 * @return none
 */
export function startPollingById(hubId) {
  pollingStopped[hubId] = false;
  const intervalTime = POLL_INTERVAL_MS;
  pollIntervals[hubId] = setInterval(doPoll, intervalTime, hubId);
}

/**
 * Stop polling on given hub
 * @param {string} hubId   - hub id to be selected
 * @return none
 */
export function stopPollingById(hubId) {
  pollingStopped[hubId] = true;
  clearInterval(pollIntervals[hubId]);
}


/**
 * Select hub by id, starts hub polling
 * @param  {string} hubId   - hub id to be selected
 * @param  {boolean} poll  - flag to start polling when connected, defaults to false
 * @return none
 */
export function selectHubById(hubId, poll = false) {
  const hubs = getHubs();

  (Object.values(hubs)).forEach((hub) =&gt; {
    if (hubId === hub.id) {
      store.dispatch(hubsState.actions.selectHub({ hubId: hub.id }));
      if (hub.hubKey &amp;&amp; poll) {
        startPollingById(hub.id);
      } else {
        if (!hub.hubKey) {
          console.error(&apos;SDK selectHubById: No hub key error&apos;);
        }
        console.debug(&apos;SDK selectHubById: Ready to start polling&apos;);
      }
    }
  });
}


/**
 * Unselect hubs, stops hub pollings
 * @return none
 */
export function unSelectHubs() {
  const hubs = getHubs();
  (Object.values(hubs)).forEach((hub) =&gt; {
    store.dispatch(hubsState.actions.unSelectHub({ hubId: hub.id }));
    stopPollingById(hub.id);
  });
}

/**
 * Unselect hub by id, stops hub polling
 * @param  {string} hubId   - hub id to be selected
 * @return none
 */
export function unSelectHubById(hubId) {
  const hubs = getHubs();
  (Object.values(hubs)).forEach((hub) =&gt; {
    if (hubId === hub.id) {
      store.dispatch(hubsState.actions.unSelectHub({ hubId: hub.id }));
      stopPollingById(hub.id);
    }
  });
}

/**
 * Connect to the given hub - local or remote.
 * @param  {string} hubId
 * @param  {string} hubKey
 * @return {Promise} current hubs, should not reject never
 */
export function connectHubByTokens(hubId, hubKey) {
  return new Promise((resolve, reject) =&gt; {
    const { authKey } = storedUser();
    if (!hubId) reject(new Error(&apos;No Hub Id&apos;));
    if (!hubKey) reject(new Error(&apos;No hubKey&apos;));
    if (!authKey) reject(new Error(&apos;No AuthKey&apos;));
    const tokens = {};
    tokens[hubId] = hubKey;
    makeHubsMap(tokens, true).then(() =&gt; {
      selectHubById(hubId, false);
      resolve(getHubs());
    }).catch((error) =&gt; reject(error));
  });
}

/*
 * Listener of User state changes
 * Hub discovery is started when user&apos;s new state is AUTHENTICATED
 */
watchChanges(&apos;user.state&apos;, (newState) =&gt; {
  // Start discovery when user is authenticated
  if (newState === USER_STATES.AUTHENTICATED) {
    startDiscoveringHubs();
  }
});
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
